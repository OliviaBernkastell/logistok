<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGISTOK - Sistem Pengajuan Barang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-dark: #006D77;
            --primary-light: #83C5BE;
            --background: #EDF6F9;
            --accent-light: #FFDDD2;
            --accent-dark: #E29578;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 8px rgba(0, 109, 119, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 109, 119, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 109, 119, 0.16);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--background) 0%, #ffffff 100%);
            color: var(--text-dark);
            padding-top: 64px;
            margin: 0;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ========== BUTTONS ========== */
        .btn {
            font-weight: 600;
            border-radius: 12px;
            padding: 12px 24px;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            letter-spacing: 0.2px;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #005a63 0%, var(--primary-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-outline-primary {
            color: var(--primary-dark);
            border: 2px solid var(--primary-light);
            background: white;
        }

        .btn-outline-primary:hover {
            background: var(--primary-light);
            border-color: var(--primary-light);
            color: white;
            transform: translateY(-2px);
        }

        .btn-export {
            background: linear-gradient(135deg, var(--primary-light) 0%, #70b3ab 100%);
            color: white;
            font-weight: 700;
        }

        .btn-export:hover {
            background: linear-gradient(135deg, #70b3ab 0%, var(--primary-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-dark) 0%, #d08567 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d08567 0%, var(--accent-dark) 100%);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .btn {
                padding: 10px 20px;
                font-size: 14px;
                border-radius: 10px;
            }
        }

        /* ========== FORM CONTROLS ========== */
        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            transition: all 0.2s;
            font-size: 15px;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(131, 197, 190, 0.1);
            outline: none;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        @media (max-width: 768px) {
            .form-control, .form-select {
                padding: 12px 14px;
                font-size: 14px;
                border-radius: 10px;
            }
        }

        /* ========== NAVBAR ========== */
        .navbar {
            background: white;
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .navbar-brand i {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-link {
            color: var(--text-light) !important;
            font-weight: 600;
            padding: 10px 16px !important;
            border-radius: 10px;
            transition: all 0.2s;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--background);
            color: var(--primary-dark) !important;
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%);
            color: white !important;
            box-shadow: var(--shadow-sm);
        }

        .nav-link i {
            margin-right: 6px;
            font-size: 16px;
        }

        @media (max-width: 991px) {
            .navbar-brand {
                font-size: 20px;
            }
            
            .nav-link {
                padding: 12px 16px !important;
                margin: 4px 0;
            }
            
            .navbar-collapse {
                margin-top: 12px;
                background: white;
                border-radius: 12px;
                padding: 12px;
            }
        }

        /* ========== HEADER SECTION ========== */
        .header-section {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #004d56 100%);
            padding: 60px 0 100px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .header-icon {
            font-size: 56px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .header-title {
            font-size: 48px;
            font-weight: 800;
            color: white;
            margin-bottom: 12px;
            letter-spacing: -1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .header-section {
                padding: 40px 0 80px;
            }
            
            .header-icon {
                font-size: 40px;
                margin-bottom: 16px;
            }
            
            .header-title {
                font-size: 32px;
                margin-bottom: 8px;
            }
            
            .header-subtitle {
                font-size: 16px;
            }
        }

        /* ========== MAIN CONTAINER ========== */
        .main-container {
            position: relative;
            z-index: 10;
            margin-top: -60px;
            padding-bottom: 60px;
        }

        /* ========== CARDS ========== */
        .form-card, .content-card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .form-header {
            background: linear-gradient(135deg, var(--background) 0%, white 100%);
            padding: 32px 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .form-header h2 {
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .form-header p {
            color: var(--text-light);
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .form-card, .content-card {
                border-radius: 16px;
            }
            
            .form-header {
                padding: 24px 20px;
            }
            
            .form-header h2 {
                font-size: 20px;
            }
            
            .form-header p {
                font-size: 13px;
            }
        }

        /* ========== FORM SECTIONS ========== */
        .form-section {
            padding: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--background);
        }

        .section-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            color: white;
            font-size: 20px;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            letter-spacing: -0.3px;
        }

        @media (max-width: 768px) {
            .form-section {
                padding: 20px 16px;
            }
            
            .section-header {
                margin-bottom: 20px;
                padding-bottom: 14px;
            }
            
            .section-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
                border-radius: 10px;
            }
            
            .section-title {
                font-size: 16px;
            }
        }

        /* ========== CUSTOM DROPDOWN ========== */
        .custom-dropdown {
            position: relative;
        }

        .custom-dropdown .form-control {
            cursor: text;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23006D77' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px 12px;
            padding-right: 44px;
        }

        .custom-dropdown.show .form-control {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(131, 197, 190, 0.1);
        }

        .custom-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            z-index: 1000;
            display: none;
            min-width: 100%;
            padding: 8px;
            margin: 0;
            background-color: white;
            border: 2px solid var(--primary-light);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-height: 320px;
            overflow-y: auto;
        }

        .custom-dropdown.show .custom-dropdown-menu {
            display: block;
        }

        .custom-dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .custom-dropdown-menu::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 10px;
        }

        .custom-dropdown-menu::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .custom-dropdown-item {
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            color: var(--text-dark);
            margin: 2px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .custom-dropdown-item:hover, .custom-dropdown-item.active {
            background: linear-gradient(135deg, var(--primary-light) 0%, #70b3ab 100%);
            color: white;
        }

        .custom-dropdown-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .dropdown-item-icon {
            margin-right: 12px;
            color: var(--primary-light);
            width: 20px;
            flex-shrink: 0;
            transition: color 0.15s;
            font-size: 16px;
        }

        .custom-dropdown-item:hover .dropdown-item-icon,
        .custom-dropdown-item.active .dropdown-item-icon {
            color: white;
        }

        .dropdown-item-text {
            flex: 1;
            font-weight: 500;
        }

        .dropdown-item-text .highlight {
            background: var(--accent-light);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .custom-dropdown-item:hover .highlight,
        .custom-dropdown-item.active .highlight {
            background: white;
            color: var(--primary-dark);
        }

        .stock-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-left: auto;
            letter-spacing: 0.3px;
        }

        .stock-badge.high {
            background: rgba(131, 197, 190, 0.15);
            color: var(--primary-dark);
            border: 1.5px solid var(--primary-light);
        }

        .stock-badge.medium {
            background: var(--accent-light);
            color: var(--accent-dark);
            border: 1.5px solid var(--accent-dark);
        }

        .stock-badge.low {
            background: rgba(226, 149, 120, 0.15);
            color: var(--accent-dark);
            border: 1.5px solid var(--accent-dark);
        }

        .custom-dropdown-item:hover .stock-badge,
        .custom-dropdown-item.active .stock-badge {
            background: white;
            color: var(--primary-dark);
            border-color: white;
        }

        .typing-indicator {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            color: var(--primary-light);
            font-size: 14px;
        }

        .custom-dropdown.typing .typing-indicator {
            display: block;
        }

        .no-results {
            padding: 24px;
            text-align: center;
            color: var(--text-light);
        }

        @media (max-width: 768px) {
            .custom-dropdown .form-control {
                padding-right: 40px;
            }
            
            .custom-dropdown-menu {
                max-height: 280px;
            }
            
            .custom-dropdown-item {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        /* ========== ITEM CARDS ========== */
        .item-card {
            background: white;
            border: 2px solid var(--primary-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .item-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .item-quantity {
            color: var(--primary-light);
            font-size: 14px;
            font-weight: 600;
        }

        .item-keterangan {
            background: var(--background);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            font-style: italic;
            line-height: 1.5;
        }

        .remove-btn {
            background: linear-gradient(135deg, var(--accent-dark) 0%, #d08567 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 768px) {
            .item-card {
                padding: 14px;
                margin-bottom: 10px;
            }
            
            .item-name {
                font-size: 15px;
            }
            
            .item-quantity {
                font-size: 13px;
            }
            
            .item-keterangan {
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* ========== TABLES ========== */
        .table-responsive {
            border-radius: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 10px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%);
            color: white;
            font-weight: 700;
            border: none;
            padding: 16px;
            text-align: left;
            white-space: nowrap;
            font-size: 14px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .table tbody td {
            padding: 16px;
            vertical-align: middle;
            border-bottom: 1px solid var(--background);
            font-size: 14px;
        }

        .table tbody tr {
            transition: all 0.2s;
        }

        .table tbody tr:hover {
            background: var(--background);
        }

        .badge-timestamp {
            background: linear-gradient(135deg, var(--primary-light) 0%, #70b3ab 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
        }

        .badge-quantity {
            background: linear-gradient(135deg, var(--accent-light) 0%, #ffc7bb 100%);
            color: var(--accent-dark);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            display: inline-block;
        }

        .btn-tarik {
            background: linear-gradient(135deg, var(--accent-dark) 0%, #d08567 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-tarik:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 768px) {
            .table thead th {
                padding: 12px 10px;
                font-size: 12px;
            }
            
            .table tbody td {
                padding: 12px 10px;
                font-size: 13px;
            }
            
            .badge-timestamp {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .badge-quantity {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .btn-tarik {
                padding: 6px 12px;
                font-size: 11px;
            }
        }

        /* ========== INFO CARDS ========== */
        .info-card, .stats-card {
            background: linear-gradient(135deg, rgba(255, 221, 210, 0.3) 0%, rgba(255, 221, 210, 0.1) 100%);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            border: 2px solid var(--accent-light);
            box-shadow: var(--shadow-sm);
        }

        .stats-card {
            margin-bottom: 24px;
            margin-top: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .info-card, .stats-card {
                padding: 20px 16px;
                margin-top: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .stat-item {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .stat-label {
                font-size: 11px;
            }
        }

        /* ========== SEARCH & FILTERS ========== */
        .search-filter-bar {
            background: var(--background);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 44px;
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-light);
            font-size: 18px;
        }

        .filter-select {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            background: white;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .search-filter-bar {
                padding: 16px;
            }
            
            .search-box input {
                padding-left: 40px;
            }
            
            .search-box i {
                font-size: 16px;
                left: 14px;
            }
            
            .filter-select {
                padding: 12px 14px;
                font-size: 13px;
            }
        }

        /* ========== PAGINATION ========== */
        .pagination {
            margin-top: 24px;
        }

        .pagination .page-link {
            color: var(--primary-dark);
            border: 2px solid var(--border-color);
            margin: 0 4px;
            border-radius: 10px;
            transition: all 0.2s;
            font-weight: 600;
            padding: 10px 16px;
            font-size: 14px;
        }

        .pagination .page-link:hover {
            background: var(--primary-light);
            border-color: var(--primary-light);
            color: white;
            transform: translateY(-2px);
        }

        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%);
            border-color: var(--primary-dark);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .pagination .page-item.disabled .page-link {
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .pagination .page-link {
                padding: 8px 12px;
                font-size: 13px;
                margin: 0 2px;
            }
        }

        /* ========== MODALS ========== */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            border-radius: 20px 20px 0 0;
            border: none;
            padding: 24px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            border: none;
            padding: 16px 24px 24px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--background);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 14px;
        }

        .detail-value {
            color: var(--primary-light);
            font-weight: 600;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .modal-header, .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                padding: 12px 20px 20px;
            }
        }

        /* ========== SKELETON LOADING ========== */
        .skeleton {
            background: linear-gradient(90deg, var(--background) 25%, #e0e7ef 50%, var(--background) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 12px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 20px;
            margin-bottom: 10px;
        }

        .skeleton-input {
            height: 56px;
            margin-bottom: 20px;
        }

        .skeleton-row {
            height: 60px;
            margin-bottom: 8px;
        }

        /* ========== FOOTER ========== */
        footer {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #004d56 100%);
            color: white;
            padding: 48px 0;
            margin-top: 60px;
        }

        footer h5 {
            font-weight: 800;
            margin-bottom: 16px;
            font-size: 24px;
        }

        footer p {
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            footer {
                padding: 36px 0;
                margin-top: 40px;
            }
            
            footer h5 {
                font-size: 20px;
            }
            
            footer p {
                font-size: 14px;
            }
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
            color: var(--primary-light);
        }

        .empty-state h5 {
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .empty-state {
                padding: 40px 20px;
            }
            
            .empty-state i {
                font-size: 48px;
            }
        }

        /* ========== PAGE SECTIONS ========== */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* ========== CETAK DOKUMEN STYLES ========== */
        #cetakPage .input-section {
            background: var(--background);
            border: 2px solid var(--primary-light);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }

        #cetakPage .input-section h3 {
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 20px;
            font-size: 20px;
        }

        #cetakPage .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        #cetakPage .btn-generate {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        #cetakPage .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #cetakPage .action-buttons {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        #cetakPage .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20914a 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        #cetakPage .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            #cetakPage .input-section {
                padding: 20px 16px;
            }
            
            #cetakPage .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            #cetakPage .btn-generate {
                width: 100%;
                padding: 12px 24px;
            }
            
            #cetakPage .action-buttons {
                top: 70px;
                right: 10px;
                padding: 8px;
            }
            
            #cetakPage .btn-success {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* ========== LOADING OVERLAY ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 109, 119, 0.95) 0%, rgba(0, 77, 86, 0.95) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== TOAST CONTAINER ========== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1055;
        }

        .toast {
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: none;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 70px;
                right: 10px;
                left: 10px;
            }
            
            .toast {
                width: 100%;
            }
        }

        /* ========== UTILITIES ========== */
        @media (max-width: 768px) {
            .mb-4 { margin-bottom: 1.5rem !important; }
            .mb-3 { margin-bottom: 1rem !important; }
            .px-5 { padding-left: 1.5rem !important; padding-right: 1.5rem !important; }
            
            .btn-lg {
                padding: 12px 24px !important;
                font-size: 15px !important;
            }
        }

        /* ========== SCROLL HINT ========== */
        .scroll-hint {
            display: none;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, var(--accent-light) 0%, #ffc7bb 100%);
            color: var(--accent-dark);
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .scroll-hint {
                display: block;
            }
        }

        /* ========== RESPONSIVE IMPROVEMENTS ========== */
        @media (max-width: 576px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            h3 {
                font-size: 18px;
            }
            
            h5 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center; color: white;">
            <div class="loading-spinner"></div>
            <h4 id="loadingText" style="font-weight: 600;">Memproses...</h4>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); color: white;">
                    <h5 class="modal-title" style="font-weight: 700;"><i class="fas fa-lock me-2"></i>Login Rekap Pengeluaran</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                    <div class="mt-3" style="font-size: 13px; color: var(--text-light); padding: 12px; background: var(--background); border-radius: 8px;">
                        <strong style="color: var(--primary-dark);">Demo accounts:</strong><br>
                        admin / admin123<br>
                        staff / staff123
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarik -->
    <div class="modal fade" id="tarikModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--accent-dark), var(--accent-light)); color: white;">
                    <h5 class="modal-title" style="font-weight: 700;"><i class="fas fa-exclamation-triangle me-2"></i>Konfirmasi Penarikan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-dark); font-weight: 600;">Yakin ingin menarik pengajuan ini?</p>
                    <div style="background: var(--background); padding: 16px; border-radius: 12px; border: 2px solid var(--border-color);">
                        <div class="detail-row">
                            <span class="detail-label">Barang:</span>
                            <span class="detail-value" id="modalNamaBarang">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Jumlah:</span>
                            <span class="detail-value" id="modalJumlah">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Pegawai:</span>
                            <span class="detail-value" id="modalNamaPegawai">-</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmTarikBtn">Ya, Tarik</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" style="cursor: pointer;" onclick="showPage('form')">
                <i class="fas fa-boxes me-2" style="font-size: 28px;"></i>
                <div>LOGISTOK</div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="border: none; padding: 8px;">
                <i class="fas fa-bars" style="color: var(--primary-dark); font-size: 20px;"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" id="navForm" onclick="showPage('form')">
                            <i class="fas fa-file-alt"></i>Form Pengajuan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="navRiwayat" onclick="showPage('riwayat')">
                            <i class="fas fa-history"></i>Riwayat Pengajuan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="navRekap" onclick="showPageWithAuth('rekap')">
                            <i class="fas fa-chart-bar"></i>Rekap Pengeluaran
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="navCetak" onclick="showPage('cetak')">
                            <i class="fas fa-print"></i>Cetak Dokumen
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- FORM PENGAJUAN PAGE -->
    <div id="formPage" class="page-section active">
        <section class="header-section">
            <div class="container text-center">
                <div class="header-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h1 class="header-title">LOGISTOK</h1>
                <p class="header-subtitle">Sistem Pengajuan Barang</p>
            </div>
        </section>

        <div class="main-container">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <div class="card form-card border-0">
                            <div class="form-header">
                                <h2>
                                    <i class="fas fa-file-alt me-2"></i>Form Pengajuan Barang
                                </h2>
                                <p>Data dimuat langsung dari Database</p>
                            </div>

                            <!-- Loading Skeleton -->
                            <div id="formLoadingSkeleton" class="p-4">
                                <div class="skeleton skeleton-text" style="width: 30%;"></div>
                                <div class="skeleton skeleton-input"></div>
                                <div class="skeleton skeleton-text" style="width: 40%; margin-top: 2rem;"></div>
                                <div class="skeleton skeleton-input"></div>
                                <div class="row">
                                    <div class="col-6"><div class="skeleton skeleton-input"></div></div>
                                    <div class="col-6"><div class="skeleton skeleton-input"></div></div>
                                </div>
                                <div class="skeleton skeleton-input" style="height: 100px;"></div>
                            </div>

                            <!-- Form -->
                            <form id="formPengambilanBarang" style="display: none;">
                                <!-- Informasi Pegawai -->
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon"><i class="fas fa-user"></i></div>
                                        <h3 class="section-title">Informasi Pegawai</h3>
                                    </div>
                                    <div class="mb-4">
                                        <label for="namaPegawai" class="form-label">
                                            Nama Pegawai <span style="color: var(--accent-dark);">*</span>
                                        </label>
                                        <div class="custom-dropdown" id="pegawaiDropdown">
                                            <input type="text" class="form-control" id="namaPegawai" placeholder="Ketik untuk mencari pegawai..." autocomplete="off">
                                            <span class="typing-indicator"><i class="fas fa-search"></i></span>
                                            <div class="custom-dropdown-menu" id="pegawaiMenu"></div>
                                        </div>
                                        <small style="color: var(--text-light); font-size: 13px; margin-top: 6px; display: block;">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="userCount">0</span> pegawai tersedia
                                        </small>
                                    </div>
                                </div>

                                <!-- Detail Barang -->
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon"><i class="fas fa-box"></i></div>
                                        <h3 class="section-title">Detail Barang</h3>
                                    </div>
                                    <div class="mb-3">
                                        <label for="namaBarang" class="form-label">
                                            Nama Barang <span style="color: var(--accent-dark);">*</span>
                                        </label>
                                        <div class="custom-dropdown" id="barangDropdown">
                                            <input type="text" class="form-control" id="namaBarang" placeholder="Ketik untuk mencari barang..." autocomplete="off">
                                            <span class="typing-indicator"><i class="fas fa-search"></i></span>
                                            <div class="custom-dropdown-menu" id="barangMenu"></div>
                                        </div>
                                        <small style="color: var(--text-light); font-size: 13px; margin-top: 6px; display: block;">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="barangCount">0</span> item tersedia
                                        </small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="jumlah" class="form-label">Jumlah <span style="color: var(--accent-dark);">*</span></label>
                                            <input type="number" class="form-control" id="jumlah" placeholder="0" min="1">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="satuan" class="form-label">Satuan</label>
                                            <input type="text" class="form-control" id="satuan" placeholder="Auto" readonly style="background-color: var(--background);">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="keterangan" class="form-label">
                                            Keterangan Penggunaan <span style="color: var(--accent-dark);">*</span>
                                        </label>
                                        <textarea class="form-control" id="keterangan" rows="3" placeholder="Jelaskan untuk apa barang ini akan digunakan..." style="resize: vertical;"></textarea>
                                        <small style="color: var(--text-light); font-size: 13px; margin-top: 6px; display: block;">Jelaskan untuk apa barang ini akan digunakan</small>
                                    </div>
                                    <div class="text-center">
                                        <button type="button" class="btn btn-outline-primary btn-lg px-5" id="addItemBtn">
                                            <i class="fas fa-plus me-2"></i>Tambah ke Daftar
                                        </button>
                                    </div>

                                    <!-- Items List -->
                                    <div id="itemsList" style="display: none; margin-top: 2rem;">
                                        <div style="background: var(--background); border-radius: 12px; padding: 20px; border: 2px solid var(--primary-light);">
                                            <h6 style="color: var(--text-dark); margin-bottom: 16px; font-weight: 700; font-size: 16px;">
                                                <i class="fas fa-list me-2"></i>Daftar Barang (<span id="itemCount">0</span> item)
                                            </h6>
                                            <div id="itemsContainer"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Section -->
                                <div class="form-section">
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary btn-lg px-5 me-2" id="submitBtn">
                                            <i class="fas fa-paper-plane me-2"></i>Kirim Pengajuan
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-lg px-5" id="resetBtn">
                                            <i class="fas fa-undo me-2"></i>Reset Form
                                        </button>
                                    </div>
                                    <div id="successMessage" style="display: none; margin-top: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); color: white; border-radius: 12px; text-align: center; box-shadow: var(--shadow-sm);">
                                        <i class="fas fa-check-circle me-2" style="font-size: 20px;"></i>
                                        <span id="successText" style="font-weight: 600;">Pengajuan berhasil dikirim!</span>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Info Card -->
                        <div class="info-card">
                            <h6 style="color: var(--text-dark); font-weight: 700; margin-bottom: 16px; font-size: 16px;">
                                <i class="fas fa-info-circle me-2"></i>Status Koneksi Database
                            </h6>
                            <ul class="mb-0" style="color: var(--text-dark); padding-left: 20px; line-height: 1.8;">
                                <li>Status: <strong id="connectionStatus">Memuat...</strong></li>
                                <li>Total Pegawai: <strong id="totalUsers">-</strong></li>
                                <li>Total Barang: <strong id="totalBarang">-</strong></li>
                                <li>Last Update: <strong id="lastUpdate">-</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RIWAYAT PAGE -->
    <div id="riwayatPage" class="page-section">
        <section class="header-section">
            <div class="container text-center">
                <div class="header-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h1 class="header-title">Riwayat Pengajuan</h1>
                <p class="header-subtitle">Daftar Pengajuan Barang Terbaru</p>
            </div>
        </section>

        <div class="main-container">
            <div class="container">
                <!-- Stats Card -->
                <div class="stats-card">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalPengajuan">0</div>
                            <div class="stat-label">Total Pengajuan</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalItems">0</div>
                            <div class="stat-label">Total Item</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="riwayatLastUpdate">-</div>
                            <div class="stat-label">Last Update</div>
                        </div>
                    </div>
                </div>

                <!-- Content Card -->
                <div class="content-card" style="padding: 24px;">
                    <!-- Search & Filter -->
                    <div class="search-filter-bar">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Cari nama pegawai, barang, atau keterangan...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select filter-select" id="filterPegawai">
                                    <option value="">Semua Pegawai</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select filter-select" id="filterBarang">
                                    <option value="">Semua Barang</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 style="color: var(--text-dark); margin: 0; font-weight: 700; font-size: 20px;">
                            <i class="fas fa-list me-2"></i>Data Pengajuan
                        </h3>
                        <span style="color: var(--text-light); font-size: 13px; font-weight: 600;">
                            Showing <span id="showingRange">0-0</span> of <span id="totalRecords">0</span>
                        </span>
                    </div>

                    <!-- Loading Skeleton -->
                    <div id="tableLoadingSkeleton">
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                    </div>

                    <!-- Table Content -->
                    <div id="tableContent" style="display: none;">
                        <div class="scroll-hint">
                            <i class="fas fa-arrows-alt-h me-2"></i>Geser ke kanan untuk melihat lebih banyak
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 160px;">Timestamp</th>
                                        <th style="min-width: 150px;">Nama Pegawai</th>
                                        <th style="min-width: 150px;">Nama Barang</th>
                                        <th style="min-width: 100px;">Jumlah</th>
                                        <th style="min-width: 200px;">Keterangan</th>
                                        <th style="min-width: 100px;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody"></tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <i class="fas fa-inbox"></i>
                            <h5>Belum Ada Data</h5>
                            <p>Belum ada pengajuan yang tercatat</p>
                        </div>

                        <!-- Pagination -->
                        <nav id="paginationNav" style="display: none;">
                            <ul class="pagination justify-content-center" id="pagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REKAP PAGE -->
    <div id="rekapPage" class="page-section">
        <section class="header-section">
            <div class="container text-center">
                <div class="header-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h1 class="header-title">Rekap Pengeluaran</h1>
                <p class="header-subtitle">Laporan Bulanan</p>
            </div>
        </section>

        <div class="main-container">
            <div class="container">
                <div class="content-card" style="padding: 24px;">
                    <h4 class="mb-4" style="font-weight: 700; color: var(--text-dark);">
                        <i class="fas fa-filter me-2"></i>Filter Periode
                    </h4>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Tahun</label>
                            <select class="form-select" id="filterTahun"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bulan</label>
                            <select class="form-select" id="filterBulan">
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadRecapData()">
                                <i class="fas fa-search me-2"></i>Tampilkan
                            </button>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="rekapTableLoading" style="display: none;">
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                        <div class="skeleton skeleton-row"></div>
                    </div>

                    <!-- Table Content -->
                    <div id="rekapTableContent" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 style="font-weight: 700; color: var(--text-dark);"><i class="fas fa-table me-2"></i>Hasil Rekap</h5>
                            <button class="btn btn-export" onclick="downloadExcel()" id="downloadExcelBtn">
                                <i class="fas fa-download me-2"></i>Download Excel
                            </button>
                        </div>

                        <div class="scroll-hint">
                            <i class="fas fa-arrows-alt-h me-2"></i>Geser ke kanan untuk melihat semua kolom
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped" id="rekapTable">
                                <thead>
                                    <tr>
                                        <th style="min-width: 50px;">No</th>
                                        <th style="min-width: 200px;">Nama Barang</th>
                                        <th style="min-width: 80px;">Jumlah</th>
                                        <th style="min-width: 80px;">Satuan</th>
                                        <th style="min-width: 250px;">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="rekapTableBody"></tbody>
                            </table>
                        </div>

                        <div id="rekapEmpty" class="text-center py-5" style="display: none; color: var(--text-light);">
                            <i class="fas fa-inbox" style="font-size: 64px; opacity: 0.3; color: var(--primary-light);"></i>
                            <h5 style="color: var(--text-dark); font-weight: 700; margin-top: 16px;">Tidak Ada Data</h5>
                            <p>Belum ada pengajuan untuk periode ini</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CETAK PAGE -->
    <div id="cetakPage" class="page-section">
        <section class="header-section">
            <div class="container text-center">
                <div class="header-icon">
                    <i class="fas fa-print"></i>
                </div>
                <h1 class="header-title">Cetak Dokumen</h1>
                <p class="header-subtitle">Surat Permintaan Barang ATK & ARK</p>
            </div>
        </section>

        <div class="main-container">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <div class="card form-card border-0">
                            <div class="form-header">
                                <h2>
                                    <i class="fas fa-file-word me-2"></i>Generate Surat Permintaan Barang
                                </h2>
                                <p>Data diambil dari pengajuan yang telah disetujui</p>
                            </div>
                            <div class="p-4">
                                <div class="input-section">
                                    <h3>Generate Surat Permintaan Barang</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="selectTahun" class="form-label">Tahun:</label>
                                            <select id="selectTahun" class="form-select"><option value="">-- Pilih --</option></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="selectBulan" class="form-label">Bulan:</label>
                                            <select id="selectBulan" class="form-select">
                                                <option value="">-- Pilih --</option>
                                                <option value="1">Januari</option>
                                                <option value="2">Februari</option>
                                                <option value="3">Maret</option>
                                                <option value="4">April</option>
                                                <option value="5">Mei</option>
                                                <option value="6">Juni</option>
                                                <option value="7">Juli</option>
                                                <option value="8">Agustus</option>
                                                <option value="9">September</option>
                                                <option value="10">Oktober</option>
                                                <option value="11">November</option>
                                                <option value="12">Desember</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="selectPenerimaBarang" class="form-label">Penerima Barang:</label>
                                            <select id="selectPenerimaBarang" class="form-select"><option value="">-- Pilih --</option></select>
                                        </div>
                                    </div>
                                    <button class="btn-generate" onclick="generateDocument()">Generate Dokumen</button>
                                    <div class="loading" id="loadingMessage" style="display: none; margin-top: 10px; color: var(--primary-dark);">Memuat data...</div>
                                    <div class="error-message" id="errorMessage" style="display: none; margin-top: 10px; color: #dc3545;"></div>
                                </div>

                                <div class="action-buttons">
                                    <button class="btn btn-success" onclick="exportToWord()">
                                        <i class="fas fa-file-word me-1"></i> Export Word
                                    </button>
                                </div>

                                <div id="document-content" class="mt-4" style="padding: 20px; background: white; border-radius: 12px; border: 1px solid var(--border-color);">
                                    <table class="header-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                        <tr>
                                            <td class="logo-column" style="width: 340px; vertical-align: middle;">
                                                <div class="logo-container" style="width: 320px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                                    <img src="logo.png" alt="Logo BPS Tanjungpinang" id="mainLogo" style="width: 320px; height: 60px; object-fit: contain;" onerror="this.style.display='none'">
                                                </div>
                                            </td>
                                            <td class="spacer-column" style="width: auto; min-width: 200px;">&nbsp;</td>
                                            <td class="info-column" style="width: 250px; vertical-align: middle;">
                                                <table class="info-table" style="width: 100%; border-collapse: collapse;">
                                                    <tr>
                                                        <td class="info-label" style="text-align: left; width: 100px; padding: 2px; font-size: 11pt; border: none;">*) Nomor</td>
                                                        <td class="info-separator" style="text-align: center; width: 20px; padding: 2px; font-size: 11pt; border: none;">:</td>
                                                        <td class="info-value" style="text-align: left; width: 130px; padding: 2px; font-size: 11pt; border: none;">................</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="info-label" style="text-align: left; padding: 2px; font-size: 11pt; border: none;">*) Dibukukan</td>
                                                        <td class="info-separator" style="text-align: center; padding: 2px; font-size: 11pt; border: none;">:</td>
                                                        <td class="info-value" style="text-align: left; padding: 2px; font-size: 11pt; border: none;">................</td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>

                                    <div class="document-title" id="documentTitle" style="text-align: center; font-weight: bold; font-size: 12pt; text-decoration: underline; margin: 20px 0;">
                                        SURAT PERMINTAAN BARANG ATK & ARK BULAN [BULAN] [TAHUN]
                                    </div>

                                    <div class="work-unit" style="text-align: left; margin-bottom: 20px;">
                                        Unit Kerja : BPS Kota Tanjungpinang
                                    </div>

                                    <table class="main-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                        <thead>
                                            <tr>
                                                <th rowspan="2" class="no-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 40px;">No.</th>
                                                <th rowspan="2" class="name-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 200px;">Nama Barang</th>
                                                <th colspan="2" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal;">Banyaknya</th>
                                                <th rowspan="2" class="unit-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 80px;">Satuan</th>
                                                <th rowspan="2" class="note-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 120px;">Keterangan</th>
                                            </tr>
                                            <tr>
                                                <th class="qty-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 60px;">Diminta</th>
                                                <th class="qty-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt; font-weight: normal; width: 60px;">Disetujui*)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <tr class="data-row">
                                                <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(1)</td>
                                                <td class="name-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(2)</td>
                                                <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(3)</td>
                                                <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(4)</td>
                                                <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(5)</td>
                                                <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(6)</td>
                                            </tr>
                                            <tr class="data-row">
                                                <td colspan="6" style="border: 1px solid black; padding: 6px; text-align: center; color: #999; font-size: 11pt;">-- Generate dokumen untuk menampilkan data --</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="note-kasubbag" style="margin-top: 10px; color: red; font-size: 10pt;">
                                        *) Diisi Kasubbag
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container text-center">
            <h5>
                <i class="fas fa-boxes me-2"></i>LOGISTOK
            </h5>
            <p>Sistem Informasi Logistik dan Inventori</p>
            <p class="opacity-75" style="font-size: 14px;">
                <i class="fas fa-copyright me-1"></i>2025 - BPS Kota Tanjungpinang
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Initialize year select for Cetak
        (function() {
            const select = document.getElementById("selectTahun");
            const startYear = 2024;
            const endYear = new Date().getFullYear() + 5;
            for (let year = startYear; year <= endYear; year++) {
                let option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        })();

        // Initialize year select for Rekap
        (function() {
            const select = document.getElementById("filterTahun");
            const startYear = 2024;
            const endYear = new Date().getFullYear() + 5;
            for (let year = startYear; year <= endYear; year++) {
                let option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        })();

        // LOGISTOK - JavaScript
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZ_6GcaOLBayHjMtBPf5xCBemktRlGwKaUZGow3pX1we4UGemzuW75p65tD_f2x2bCqQ/exec';

        // Global Variables
        let userData = [];
        let barangData = [];
        let selectedItems = [];
        let currentSelectedBarang = null;
        let currentSelectedUser = null;
        let allPengajuanData = [];
        let filteredPengajuanData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let pendingTarikData = null;
        let tarikModal = null;
        let isLoggedIn = false;
        let currentUser = null;
        let loginModal = null;
        let rekapData = [];
        let dataPeran = [];
        let dataUsers = [];
        let selectedTahun = '';
        let selectedBulan = '';
        let selectedUser = null;

        const BULAN_NAMES = {
            '1': 'Januari', '2': 'Februari', '3': 'Maret', '4': 'April',
            '5': 'Mei', '6': 'Juni', '7': 'Juli', '8': 'Agustus',
            '9': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
        };

        // PAGE NAVIGATION
        function showPage(page) {
            document.querySelectorAll(".page-section").forEach(section => {
                section.classList.remove("active");
            });
            document.querySelectorAll(".nav-link").forEach(link => {
                link.classList.remove("active");
            });

            if (page === 'form') {
                document.getElementById("formPage").classList.add("active");
                document.getElementById("navForm").classList.add("active");
            } else if (page === 'riwayat') {
                document.getElementById("riwayatPage").classList.add("active");
                document.getElementById("navRiwayat").classList.add("active");
                loadPengajuanData();
            } else if (page === 'rekap') {
                document.getElementById("rekapPage").classList.add("active");
                document.getElementById("navRekap").classList.add("active");
            } else if (page === 'cetak') {
                document.getElementById("cetakPage").classList.add("active");
                document.getElementById("navCetak").classList.add("active");
                loadCetakData();
            }

            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function showPageWithAuth(page) {
            if (!isLoggedIn) {
                loginModal.show();
                return;
            }
            showPage(page);
        }

        // AUTHENTICATION
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById("loginUsername").value;
            const password = document.getElementById("loginPassword").value;

            showLoading(true, "Memverifikasi...");

            try {
                const url = `${GOOGLE_SHEETS_WEB_APP_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    isLoggedIn = true;
                    currentUser = result.user;
                    loginModal.hide();
                    showToast("Login berhasil!", "success");
                    showPage("rekap");
                } else {
                    showToast(result.message || "Login gagal", "error");
                }
            } catch (error) {
                console.error("Error login:", error);
                showToast("Terjadi kesalahan saat login", "error");
            } finally {
                showLoading(false);
            }
        }

        // REKAP FUNCTIONS
        async function loadRecapData() {
            const tahun = document.getElementById("filterTahun").value;
            const bulan = document.getElementById("filterBulan").value;

            if (!tahun || !bulan) {
                showToast("Pilih tahun dan bulan terlebih dahulu", "error");
                return;
            }

            document.getElementById("rekapTableLoading").style.display = "block";
            document.getElementById("rekapTableContent").style.display = "none";

            try {
                const url = `${GOOGLE_SHEETS_WEB_APP_URL}?action=getRecap&tahun=${tahun}&bulan=${bulan}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    rekapData = result.data;
                    renderRekapTable(result.data);
                    document.getElementById("rekapTableLoading").style.display = "none";
                    document.getElementById("rekapTableContent").style.display = "block";

                    if (result.data.length === 0) {
                        const namaBulan = getNamaBulan(bulan);
                        showToast(`Tidak ada data untuk periode ${namaBulan} ${tahun}`, "info");
                    } else {
                        showToast(`Berhasil memuat ${result.data.length} item barang`, "success");
                    }
                } else {
                    showToast(result.message || "Gagal memuat data", "error");
                    document.getElementById("rekapTableLoading").style.display = "none";
                }
            } catch (error) {
                console.error("Error loading recap:", error);
                showToast("Terjadi kesalahan saat memuat data", "error");
                document.getElementById("rekapTableLoading").style.display = "none";
            }
        }

        function renderRekapTable(data) {
            const tableBody = document.getElementById("rekapTableBody");
            const emptyState = document.getElementById("rekapEmpty");

            if (data.length === 0) {
                tableBody.innerHTML = "";
                emptyState.style.display = "block";
            } else {
                emptyState.style.display = "none";
                tableBody.innerHTML = data.map(item => `
                    <tr>
                        <td>${item.no}</td>
                        <td><strong>${item.nama_barang}</strong></td>
                        <td>${item.jumlah}</td>
                        <td>${item.satuan}</td>
                        <td style="max-width: 400px;">${item.keterangan || "-"}</td>
                    </tr>
                `).join("");
            }
        }

        function getNamaBulan(bulan) {
            const namaBulan = {
                '01': 'Januari', '02': 'Februari', '03': 'Maret',
                '04': 'April', '05': 'Mei', '06': 'Juni',
                '07': 'Juli', '08': 'Agustus', '09': 'September',
                '10': 'Oktober', '11': 'November', '12': 'Desember'
            };
            return namaBulan[bulan] || bulan;
        }

        // DOWNLOAD EXCEL
        function downloadExcel() {
            if (!rekapData || rekapData.length === 0) {
                showToast("Tidak ada data untuk didownload", "error");
                return;
            }

            const tahun = document.getElementById("filterTahun").value;
            const bulan = document.getElementById("filterBulan").value;
            const namaBulan = document.getElementById("filterBulan").selectedOptions[0].text;

            const ws_data = {};
            ws_data.A1 = {
                v: `Rekap Pengeluaran Barang Persediaan Bulan ${namaBulan} ${tahun}`,
                t: "s",
                s: {
                    font: { bold: true, sz: 14 },
                    alignment: { horizontal: "center", vertical: "center" }
                }
            };

            ws_data.A3 = { v: "No", t: "s", s: { font: { bold: true } } };
            ws_data.B3 = { v: "Nama Barang", t: "s", s: { font: { bold: true } } };
            ws_data.C3 = { v: "Jumlah", t: "s", s: { font: { bold: true } } };
            ws_data.D3 = { v: "Satuan", t: "s", s: { font: { bold: true } } };
            ws_data.E3 = { v: "Keterangan", t: "s", s: { font: { bold: true } } };

            rekapData.forEach((item, index) => {
                const row = index + 4;
                ws_data[`A${row}`] = { v: item.no, t: "n" };
                ws_data[`B${row}`] = { v: item.nama_barang, t: "s" };
                ws_data[`C${row}`] = { v: item.jumlah, t: "n" };
                ws_data[`D${row}`] = { v: item.satuan, t: "s" };
                ws_data[`E${row}`] = { v: item.keterangan || "-", t: "s" };
            });

            const lastRow = rekapData.length + 3;
            ws_data["!ref"] = `A1:E${lastRow}`;
            ws_data["!merges"] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];
            ws_data["!cols"] = [
                { wch: 5 },
                { wch: 35 },
                { wch: 10 },
                { wch: 10 },
                { wch: 50 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws_data, "Rekap Pengeluaran");

            const filename = `Rekap_Pengeluaran_${namaBulan}_${tahun}.xlsx`;
            XLSX.writeFile(wb, filename);

            showToast("File Excel berhasil didownload", "success");
        }

        // BOOTSTRAP DROPDOWN CLASS
        class BootstrapDropdown {
            constructor(containerId, inputId, menuId, data, config = {}) {
                this.container = document.getElementById(containerId);
                this.input = document.getElementById(inputId);
                this.menu = document.getElementById(menuId);
                this.data = data;
                this.filteredData = [...data];
                this.selectedIndex = -1;
                this.isOpen = false;
                this.lastQuery = "";
                this.config = {
                    searchKey: config.searchKey || "nama",
                    displayKey: config.displayKey || "nama",
                    icon: config.icon || "fas fa-search",
                    onSelect: config.onSelect || function() {},
                    renderCustom: config.renderCustom || null,
                    minChars: config.minChars || 1,
                    ...config
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.renderOptions();
            }

            setupEventListeners() {
                this.input.addEventListener("input", (e) => this.handleInput(e));
                this.input.addEventListener("focus", () => {
                    if (this.input.value.length >= this.config.minChars) {
                        this.open();
                    }
                });
                this.input.addEventListener("keydown", (e) => this.handleKeydown(e));
                document.addEventListener("click", (e) => {
                    if (!this.container.contains(e.target)) {
                        this.close();
                    }
                });
                this.menu.addEventListener("click", (e) => this.handleMenuClick(e));
            }

            handleInput(e) {
                const query = e.target.value.trim();
                if (query.length > 0) {
                    this.container.classList.add("typing");
                } else {
                    this.container.classList.remove("typing");
                }

                if (query.length >= this.config.minChars) {
                    this.filterData(query);
                    this.renderOptions();
                    this.selectedIndex = -1;
                    this.open();
                } else if (query.length === 0) {
                    this.filteredData = [...this.data];
                    this.renderOptions();
                    this.close();
                } else {
                    this.close();
                }
                this.lastQuery = query;
            }

            handleKeydown(e) {
                if (!this.isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
                    if (this.input.value.length >= this.config.minChars) {
                        this.open();
                    }
                    return;
                }

                switch (e.key) {
                    case "ArrowDown":
                        e.preventDefault();
                        this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredData.length - 1);
                        this.updateHighlight();
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                        this.updateHighlight();
                        break;
                    case "Enter":
                        e.preventDefault();
                        if (this.selectedIndex >= 0 && this.filteredData[this.selectedIndex]) {
                            this.selectItem(this.filteredData[this.selectedIndex]);
                        }
                        break;
                    case "Escape":
                        this.close();
                        this.input.blur();
                        break;
                }
            }

            handleMenuClick(e) {
                const item = e.target.closest(".custom-dropdown-item");
                if (item && !item.classList.contains("disabled")) {
                    const index = parseInt(item.dataset.index);
                    if (!isNaN(index) && this.filteredData[index]) {
                        this.selectItem(this.filteredData[index]);
                    }
                }
            }

            filterData(query) {
                const lowerQuery = query.toLowerCase();
                if (!query || query.length < this.config.minChars) {
                    this.filteredData = [...this.data];
                    return;
                }

                this.filteredData = this.data.filter(item => {
                    const searchValue = String(item[this.config.searchKey] || "").toLowerCase();
                    const nip = item.nip ? String(item.nip).toLowerCase() : "";
                    const satuan = item.satuan ? String(item.satuan).toLowerCase() : "";
                    return searchValue.includes(lowerQuery) || 
                           nip.includes(lowerQuery) || 
                           satuan.includes(lowerQuery);
                });

                this.filteredData.sort((a, b) => {
                    const aValue = String(a[this.config.searchKey] || "").toLowerCase();
                    const bValue = String(b[this.config.searchKey] || "").toLowerCase();
                    const aStarts = aValue.startsWith(lowerQuery);
                    const bStarts = bValue.startsWith(lowerQuery);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return aValue.localeCompare(bValue);
                });
            }

            renderOptions() {
                if (this.filteredData.length === 0) {
                    this.menu.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                            <div>Tidak ada hasil ditemukan</div>
                        </div>
                    `;
                    return;
                }

                const query = this.lastQuery.toLowerCase();
                if (this.config.renderCustom) {
                    this.menu.innerHTML = this.config.renderCustom(this.filteredData, query);
                    return;
                }

                this.menu.innerHTML = this.filteredData.map((item, index) => {
                    const displayValue = item[this.config.displayKey];
                    const highlighted = highlightText(displayValue, query, this.config.minChars);
                    let subtitle = "";
                    if (item.nip) {
                        subtitle = `<small style="color: var(--primary-light);">${String(item.nip)}</small>`;
                    }
                    return `
                        <div class="custom-dropdown-item" data-index="${index}">
                            <i class="${this.config.icon} dropdown-item-icon"></i>
                            <div class="dropdown-item-text">${highlighted}</div>
                            <div>${subtitle}</div>
                        </div>
                    `;
                }).join("");
            }

            updateHighlight() {
                const items = this.menu.querySelectorAll(".custom-dropdown-item");
                items.forEach((item, index) => {
                    item.classList.toggle("active", index === this.selectedIndex);
                });
                if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                    items[this.selectedIndex].scrollIntoView({ block: "nearest", behavior: "smooth" });
                }
            }

            selectItem(item) {
                this.input.value = item[this.config.displayKey];
                this.close();
                this.container.classList.remove("typing");
                this.config.onSelect(item);
            }

            open() {
                if (!this.isOpen) {
                    this.isOpen = true;
                    this.container.classList.add("show");
                    this.selectedIndex = -1;
                }
            }

            close() {
                if (this.isOpen) {
                    this.isOpen = false;
                    this.container.classList.remove("show");
                    this.container.classList.remove("typing");
                }
            }

            reset() {
                this.input.value = "";
                this.close();
                this.container.classList.remove("typing");
                this.filteredData = [...this.data];
                this.lastQuery = "";
                this.renderOptions();
            }

            updateData(newData) {
                this.data = newData;
                this.filteredData = [...newData];
                this.renderOptions();
            }
        }

        // UTILITY FUNCTIONS
function highlightText(text, query, minChars = 1) {
    if (!query || query.length < minChars) {
        return text;
    }
    const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const regex = new RegExp(`(${escapeRegex(query)})`, "gi");
    return text.replace(regex, '<span class="highlight">$1</span>');
}

        // DATA LOADING
        async function loadDataFromSheets() {
            try {
                const response = await fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getAll`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status !== 'success' || !result.data) {
                    throw new Error(result.message || "Invalid response format");
                }

                userData = result.data.users.map(user => ({
                    id_user: user.id_user,
                    nama: user.nama,
                    nip: user.nip
                }));
                barangData = result.data.barang.map(item => ({
                    id_barang: item.id_barang,
                    nama: item.uraian,
                    uraian: item.uraian,
                    satuan: item.satuan,
                    tersedia: item.tersedia,
                    diajukan: item.diajukan,
                    disetujui: item.disetujui
                }));

                document.getElementById("userCount").textContent = userData.length;
                document.getElementById("barangCount").textContent = barangData.length;
                document.getElementById("totalUsers").textContent = userData.length;
                document.getElementById("totalBarang").textContent = barangData.length;
                document.getElementById("connectionStatus").textContent = "Terhubung ✓";
                document.getElementById("connectionStatus").style.color = "var(--primary-dark)";
                document.getElementById("lastUpdate").textContent = new Date().toLocaleString("id-ID");

                document.getElementById("formLoadingSkeleton").style.display = "none";
                document.getElementById("formPengambilanBarang").style.display = "block";

                showToast(`Data dimuat: ${userData.length} pegawai, ${barangData.length} barang`, "success");
            } catch (error) {
                console.error("Error loading data:", error);
                showToast("Gagal memuat data: " + error.message, "error");
                document.getElementById("connectionStatus").textContent = "Error ✗";
                document.getElementById("connectionStatus").style.color = "var(--accent-dark)";
                userData = [];
                barangData = [];
                document.getElementById("formLoadingSkeleton").style.display = "none";
                document.getElementById("formPengambilanBarang").style.display = "block";
            }
        }

        // DROPDOWN INITIALIZATION
        function initializeDropdowns() {
            window.pegawaiDropdown = new BootstrapDropdown(
                "pegawaiDropdown",
                "namaPegawai",
                "pegawaiMenu",
                userData,
                {
                    searchKey: "nama",
                    displayKey: "nama",
                    icon: "fas fa-user",
                    minChars: 1,
                    onSelect: function(user) {
                        currentSelectedUser = user;
                        showToast(`Pegawai ${user.nama} dipilih`, "success");
                    }
                }
            );

            window.barangDropdown = new BootstrapDropdown(
                "barangDropdown",
                "namaBarang",
                "barangMenu",
                barangData,
                {
                    searchKey: "nama",
                    displayKey: "nama",
                    icon: "fas fa-cube",
                    minChars: 1,
                    renderCustom: function(items, query) {
                        return items.map((item, index) => {
                            const highlighted = highlightText(item.nama, query, 1);
                            const stockClass = item.tersedia > 20 ? "high" : (item.tersedia > 5 ? "medium" : "low");
                            const stockText = item.tersedia === 0 ? "Habis" : item.tersedia;
                            const isAdded = selectedItems.some(selected => selected.id_barang === item.id_barang);
                            const disabledClass = isAdded ? "disabled" : "";
                            const addedBadge = isAdded ? '<span style="margin-left: 0.5rem; font-size: 0.7rem; background: var(--accent-dark); color: white; padding: 0.1rem 0.4rem; border-radius: 4px;">✓ Ditambahkan</span>' : "";

                            return `
                                <div class="custom-dropdown-item ${disabledClass}" data-index="${index}">
                                    <i class="fas fa-cube dropdown-item-icon"></i>
                                    <div class="dropdown-item-text">
                                        ${highlighted} ${addedBadge}
                                        <small style="display: block; color: var(--primary-light); font-size: 0.85em; margin-top: 0.25rem;">
                                            ${item.satuan} | Tersedia: ${stockText}
                                        </small>
                                    </div>
                                    <span class="stock-badge ${stockClass}">${stockText}</span>
                                </div>
                            `;
                        }).join("");
                    },
                    onSelect: function(item) {
                        if (selectedItems.some(selected => selected.id_barang === item.id_barang)) {
                            showToast("Barang ini sudah ada di daftar!", "error");
                            return;
                        }
                        currentSelectedBarang = item;
                        document.getElementById("satuan").value = item.satuan;
                        const jumlahInput = document.getElementById("jumlah");
                        if (item.tersedia === 0) {
                            jumlahInput.disabled = true;
                            jumlahInput.placeholder = "Stok habis";
                            jumlahInput.value = "";
                            showToast(`${item.nama} stok habis!`, "error");
                        } else {
                            jumlahInput.disabled = false;
                            jumlahInput.placeholder = `Max: ${item.tersedia}`;
                            jumlahInput.max = item.tersedia;
                            jumlahInput.focus();
                            showToast(`${item.nama} dipilih (Stok: ${item.tersedia})`, "success");
                        }
                    }
                }
            );
        }

        // FORM HANDLERS
        function initializeFormHandlers() {
            document.getElementById("addItemBtn").addEventListener("click", addItemToList);
            document.getElementById("resetBtn").addEventListener("click", resetForm);
            document.getElementById("formPengambilanBarang").addEventListener("submit", function(e) {
                e.preventDefault();
                submitForm();
            });
        }

        function addItemToList() {
            const namaBarang = document.getElementById("namaBarang").value;
            const jumlah = parseInt(document.getElementById("jumlah").value);
            const satuan = document.getElementById("satuan").value;
            const keterangan = document.getElementById("keterangan").value.trim();

            if (!currentSelectedBarang) {
                showToast("Pilih barang terlebih dahulu", "error");
                return;
            }

            if (selectedItems.some(item => item.id_barang === currentSelectedBarang.id_barang)) {
                showToast(`${namaBarang} sudah ada di daftar!`, "error");
                return;
            }

            if (!jumlah || jumlah <= 0) {
                document.getElementById("jumlah").focus();
                showToast("Masukkan jumlah yang valid", "error");
                return;
            }

            if (jumlah > currentSelectedBarang.tersedia) {
                document.getElementById("jumlah").value = currentSelectedBarang.tersedia;
                showToast(`Jumlah melebihi stok tersedia (${currentSelectedBarang.tersedia})`, "error");
                return;
            }

            if (!keterangan) {
                document.getElementById("keterangan").focus();
                showToast("Isi keterangan penggunaan untuk barang ini", "error");
                return;
            }

            selectedItems.push({
                id_barang: currentSelectedBarang.id_barang,
                nama: namaBarang,
                jumlah: jumlah,
                satuan: satuan,
                keterangan: keterangan,
                stok_tersedia: currentSelectedBarang.tersedia
            });

            renderItemsList();
            clearCurrentSelection();
            showToast(`${namaBarang} ditambahkan ke daftar`, "success");
            document.getElementById("namaBarang").focus();
        }

        function renderItemsList() {
            const itemsList = document.getElementById("itemsList");
            const itemsContainer = document.getElementById("itemsContainer");
            const itemCount = document.getElementById("itemCount");

            if (selectedItems.length === 0) {
                itemsList.style.display = "none";
            } else {
                itemsList.style.display = "block";
                itemCount.textContent = selectedItems.length;
                itemsContainer.innerHTML = selectedItems.map((item, index) => `
                    <div class="item-card">
                        <div class="item-header">
                            <div style="flex: 1;">
                                <div class="item-name">${item.nama}</div>
                                <div class="item-quantity">${item.jumlah} ${item.satuan}</div>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeItem(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="item-keterangan">
                            <i class="fas fa-info-circle me-1"></i>${item.keterangan}
                        </div>
                    </div>
                `).join("");
            }
        }

        function removeItem(index) {
            const item = selectedItems[index];
            selectedItems.splice(index, 1);
            renderItemsList();
            showToast(`${item.nama} dihapus dari daftar`, "info");
            if (window.barangDropdown && window.barangDropdown.isOpen) {
                window.barangDropdown.renderOptions();
            }
        }

        function clearCurrentSelection() {
            document.getElementById("namaBarang").value = "";
            document.getElementById("jumlah").value = "";
            document.getElementById("satuan").value = "";
            document.getElementById("keterangan").value = "";
            document.getElementById("jumlah").disabled = false;
            document.getElementById("jumlah").placeholder = "0";
            currentSelectedBarang = null;
            if (window.barangDropdown) {
                window.barangDropdown.reset();
            }
        }

        function resetForm() {
            if ((selectedItems.length > 0 || document.getElementById("namaPegawai").value) && 
                !confirm("Yakin ingin reset form? Semua data akan hilang.")) {
                return;
            }

            document.getElementById("formPengambilanBarang").reset();
            clearCurrentSelection();
            selectedItems = [];
            currentSelectedUser = null;
            renderItemsList();
            document.getElementById("successMessage").style.display = "none";
            if (window.pegawaiDropdown) {
                window.pegawaiDropdown.reset();
            }
            showToast("Form berhasil direset", "info");
        }

        async function submitForm() {
            const namaPegawai = document.getElementById("namaPegawai").value;
            if (!namaPegawai) {
                showToast("Pilih nama pegawai terlebih dahulu", "error");
                return;
            }
            if (!currentSelectedUser) {
                showToast("Data pegawai tidak valid. Pilih ulang dari dropdown.", "error");
                return;
            }
            if (selectedItems.length === 0) {
                showToast("Tambahkan minimal 1 barang", "error");
                return;
            }

            const dataToSend = {
                pegawai: currentSelectedUser,
                items: selectedItems,
                timestamp: new Date().toLocaleString("id-ID"),
                total_items: selectedItems.length
            };

            const submitBtn = document.getElementById("submitBtn");
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Mengirim...';
            submitBtn.disabled = true;
            showLoading(true, "Mengirim pengajuan...");

            try {
                await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(dataToSend)
                });

                submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Berhasil!';
                const successMessage = document.getElementById("successMessage");
                document.getElementById("successText").textContent = 
                    `Pengajuan berhasil dikirim! ${selectedItems.length} item barang telah diproses.`;
                successMessage.style.display = "block";
                showToast(`Pengajuan berhasil! ${selectedItems.length} item tersimpan di database.`, "success");

                await loadDataFromSheets();

                setTimeout(() => {
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    document.getElementById("formPengambilanBarang").reset();
                    clearCurrentSelection();
                    selectedItems = [];
                    currentSelectedUser = null;
                    renderItemsList();
                    successMessage.style.display = "none";
                    if (window.pegawaiDropdown) {
                        window.pegawaiDropdown.reset();
                    }
                    window.scrollTo({ top: 0, behavior: "smooth" });
                    showToast("Form berhasil direset", "info");
                }, 2000);
            } catch (error) {
                console.error("Error submitting form:", error);
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                showToast("Terjadi kesalahan saat mengirim data. Silakan coba lagi.", "error");
            } finally {
                showLoading(false);
            }
        }

        // RIWAYAT PENGAJUAN
        async function loadPengajuanData() {
            try {
                document.getElementById("tableLoadingSkeleton").style.display = "block";
                document.getElementById("tableContent").style.display = "none";

                const response = await fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getPengajuan`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.status !== 'success' || !result.data) {
                    throw new Error(result.message || "Invalid response format");
                }

                allPengajuanData = result.data;
                allPengajuanData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                filteredPengajuanData = allPengajuanData;

                populateFilters();
                updateStats();
                renderTable();
                renderPagination();

                document.getElementById("tableLoadingSkeleton").style.display = "none";
                document.getElementById("tableContent").style.display = "block";
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById("tableLoadingSkeleton").style.display = "none";
                document.getElementById("tableContent").style.display = "block";
                document.getElementById("emptyState").style.display = "block";
            }
        }

        function populateFilters() {
            const pegawaiList = [...new Set(allPengajuanData.map(item => item.nama_pegawai))].sort();
            const barangList = [...new Set(allPengajuanData.map(item => item.nama_barang))].sort();

            const filterPegawai = document.getElementById("filterPegawai");
            const filterBarang = document.getElementById("filterBarang");

            filterPegawai.innerHTML = '<option value="">Semua Pegawai</option>' +
                pegawaiList.map(nama => `<option value="${nama}">${nama}</option>`).join("");
            filterBarang.innerHTML = '<option value="">Semua Barang</option>' +
                barangList.map(nama => `<option value="${nama}">${nama}</option>`).join("");

            document.getElementById("searchInput").addEventListener("input", applyFilters);
            filterPegawai.addEventListener("change", applyFilters);
            filterBarang.addEventListener("change", applyFilters);
        }

        function applyFilters() {
            const searchQuery = document.getElementById("searchInput").value.toLowerCase();
            const filterPegawai = document.getElementById("filterPegawai").value;
            const filterBarang = document.getElementById("filterBarang").value;

            filteredPengajuanData = allPengajuanData.filter(item => {
                const matchSearch = !searchQuery || 
                    item.nama_pegawai.toLowerCase().includes(searchQuery) ||
                    item.nama_barang.toLowerCase().includes(searchQuery) ||
                    item.keterangan.toLowerCase().includes(searchQuery);
                const matchPegawai = !filterPegawai || item.nama_pegawai === filterPegawai;
                const matchBarang = !filterBarang || item.nama_barang === filterBarang;
                return matchSearch && matchPegawai && matchBarang;
            });

            currentPage = 1;
            updateStats();
            renderTable();
            renderPagination();
        }

        function updateStats() {
            document.getElementById("totalPengajuan").textContent = filteredPengajuanData.length;
            const totalItems = filteredPengajuanData.reduce((sum, item) => sum + (item.jumlah || 0), 0);
            document.getElementById("totalItems").textContent = totalItems;
            document.getElementById("riwayatLastUpdate").textContent = 
                new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
        }

        function renderTable() {
            const tableBody = document.getElementById("dataTableBody");
            const emptyState = document.getElementById("emptyState");

            if (filteredPengajuanData.length === 0) {
                tableBody.innerHTML = "";
                emptyState.style.display = "block";
                document.getElementById("paginationNav").style.display = "none";
                return;
            }

            emptyState.style.display = "none";
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredPengajuanData.slice(startIndex, endIndex);

            tableBody.innerHTML = pageData.map(item => `
                <tr>
                    <td>
                        <span class="badge-timestamp">
                            <i class="far fa-clock me-1"></i>${formatTimestamp(item.timestamp)}
                        </span>
                    </td>
                    <td><strong>${item.nama_pegawai}</strong></td>
                    <td>${item.nama_barang}</td>
                    <td>
                        <span class="badge-quantity">${item.jumlah} ${item.satuan}</span>
                    </td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-style: italic; color: var(--text-light);" 
                             title="${item.keterangan}">
                            ${item.keterangan}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-tarik" onclick='showTarikModal(${JSON.stringify(item)})'>
                            <i class="fas fa-undo me-1"></i>Tarik
                        </button>
                    </td>
                </tr>
            `).join("");

            document.getElementById("showingRange").textContent = `${startIndex + 1}-${Math.min(endIndex, filteredPengajuanData.length)}`;
            document.getElementById("totalRecords").textContent = filteredPengajuanData.length;
        }

        function showTarikModal(data) {
            pendingTarikData = data;
            document.getElementById("modalNamaBarang").textContent = data.nama_barang;
            document.getElementById("modalJumlah").textContent = `${data.jumlah} ${data.satuan}`;
            document.getElementById("modalNamaPegawai").textContent = data.nama_pegawai;
            tarikModal.show();
        }

        async function confirmTarik() {
            if (!pendingTarikData) return;

            tarikModal.hide();
            showLoading(true, "Menarik pengajuan...");

            try {
                const dataToSend = {
                    action: "tarikPengajuan",
                    row_index: pendingTarikData.row_index,
                    nama_barang: pendingTarikData.nama_barang,
                    jumlah: pendingTarikData.jumlah
                };

                await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(dataToSend)
                });

                showToast("Pengajuan berhasil ditarik dan stok dikembalikan", "success");
                await loadDataFromSheets();
                await loadPengajuanData();
            } catch (error) {
                console.error("Error tarik pengajuan:", error);
                showToast("Terjadi kesalahan saat menarik pengajuan", "error");
            } finally {
                showLoading(false);
                pendingTarikData = null;
            }
        }

        function renderPagination() {
            const pagination = document.getElementById("pagination");
            const paginationNav = document.getElementById("paginationNav");

            if (filteredPengajuanData.length === 0) {
                paginationNav.style.display = "none";
                return;
            }

            const totalPages = Math.ceil(filteredPengajuanData.length / itemsPerPage);
            if (totalPages <= 1) {
                paginationNav.style.display = "none";
                return;
            }

            paginationNav.style.display = "block";
            let html = "";

            html += `
                <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `
                        <li class="page-item ${currentPage === i ? "active" : ""}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            html += `
                <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredPengajuanData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString("id-ID", {
                day: "2-digit",
                month: "short",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        // CETAK DOKUMEN FUNCTIONS
        async function loadCetakData() {
            showLoading(true);
            try {
                const [peran, users, periods] = await Promise.all([
                    fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getPeran`).then(r => r.json()),
                    fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getUsers`).then(r => r.json()),
                    fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getAvailablePeriods`).then(r => r.json())
                ]);

                if (peran.status === 'success') dataPeran = peran.data;
                if (users.status === 'success') {
                    dataUsers = users.data;
                    const select = document.getElementById('selectPenerimaBarang');
                    select.innerHTML = '<option value="">-- Pilih --</option>';
                    users.data.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id_user;
                        opt.textContent = `${u.nama} (${u.nip})`;
                        opt.dataset.nama = u.nama;
                        opt.dataset.nip = u.nip;
                        select.appendChild(opt);
                    });
                }
                if (periods.status === 'success') {
                    const select = document.getElementById('selectTahun');
                    select.innerHTML = '<option value="">-- Pilih --</option>';
                    periods.years.forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y;
                        opt.textContent = y;
                        select.appendChild(opt);
                    });
                }

                showLoading(false);
            } catch (error) {
                showError('Gagal memuat data: ' + error.message);
                showLoading(false);
            }
        }

        async function generateDocument() {
            selectedTahun = document.getElementById('selectTahun').value;
            selectedBulan = document.getElementById('selectBulan').value;
            const selectedUserId = document.getElementById('selectPenerimaBarang').value;

            if (!selectedTahun || !selectedBulan || !selectedUserId) {
                showError('Mohon lengkapi semua field!');
                return;
            }

            const userSelect = document.getElementById('selectPenerimaBarang');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            selectedUser = {
                id: selectedUserId,
                nama: selectedOption.dataset.nama,
                nip: selectedOption.dataset.nip
            };

            showLoading(true);
            showError('');

            try {
                const response = await fetch(`${GOOGLE_SHEETS_WEB_APP_URL}?action=getPengajuan`);
                const result = await response.json();

                if (result.status === 'success' && result.data && result.data.length > 0) {
                    const filtered = result.data.filter(item => {
                        const itemTahun = parseInt(item.tahun);
                        const itemBulan = parseInt(item.bulan);
                        const itemUserId = parseInt(item.id_user);
                        return itemTahun === parseInt(selectedTahun) && 
                               itemBulan === parseInt(selectedBulan) && 
                               itemUserId === parseInt(selectedUserId);
                    });

                    if (filtered.length > 0) {
                        const agregasi = {};
                        filtered.forEach(item => {
                            if (!agregasi[item.nama_barang]) {
                                agregasi[item.nama_barang] = {
                                    nama_barang: item.nama_barang,
                                    jumlah: 0,
                                    satuan: item.satuan,
                                    keterangan_list: []
                                };
                            }
                            agregasi[item.nama_barang].jumlah += parseInt(item.jumlah) || 0;
                            if (item.keterangan && item.keterangan.trim() !== '') {
                                agregasi[item.nama_barang].keterangan_list.push(item.keterangan);
                            }
                        });

                        const dataAggregated = Object.values(agregasi).map(item => {
                            const uniqueKeterangan = [...new Set(item.keterangan_list)];
                            return {
                                nama_barang: item.nama_barang,
                                jumlah: item.jumlah,
                                satuan: item.satuan,
                                keterangan: uniqueKeterangan.length > 0 ? uniqueKeterangan.join('; ') : '-'
                            };
                        });

                        dataAggregated.sort((a, b) => a.nama_barang.localeCompare(b.nama_barang));
                        populateDocument(dataAggregated);
                        showLoading(false);
                    } else {
                        showError(`Tidak ada pengajuan untuk ${selectedUser.nama} di periode yang dipilih!`);
                        showLoading(false);
                    }
                } else {
                    showError('Tidak ada data pengajuan!');
                    showLoading(false);
                }
            } catch (error) {
                showError('Gagal memuat data: ' + error.message);
                showLoading(false);
            }
        }

        function populateDocument(data) {
            const bulanName = BULAN_NAMES[selectedBulan];
            document.getElementById('documentTitle').textContent = 
                `SURAT PERMINTAAN BARANG ATK & ARK BULAN ${bulanName.toUpperCase()} ${selectedTahun}`;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const headerRow = `<tr class="data-row"><td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(1)</td><td class="name-column" style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(2)</td><td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(3)</td><td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(4)</td><td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(5)</td><td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">(6)</td></tr>`;
            tbody.insertAdjacentHTML('beforeend', headerRow);

            data.forEach((item, i) => {
                const row = `<tr class="data-row">
                    <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">${i + 1}.</td>
                    <td class="name-column" style="border: 1px solid black; padding: 6px; text-align: left; font-size: 11pt;">${item.nama_barang}</td>
                    <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">${item.jumlah}</td>
                    <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">${item.jumlah}</td>
                    <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">${item.satuan}</td>
                    <td style="border: 1px solid black; padding: 6px; text-align: center; font-size: 11pt;">${item.keterangan || '-'}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            const pejabatPengadaan = dataPeran.find(p => p.jabatan.toLowerCase().includes('pengadaan'));
            const kasubbag = dataPeran.find(p => p.jabatan.toLowerCase().includes('sub bagian umum'));
            const petugasGudang = dataPeran.find(p => p.jabatan.toLowerCase().includes('gudang'));

            const signatureRows = `
                <tr class="signature-row">
                    <td colspan="6" style="border-left: 1px solid black; border-right: 1px solid black; border-top: 1px solid black; border-bottom: none; padding: 15px;">
                        <table style="width: 100%; border: none;">
                            <tr>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    Setuju Dikeluarkan :<br>Pejabat Pengadaan
                                </td>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    Tanjungpinang, ........................ ${selectedTahun}.-<br>
                                    Kepala Sub Bagian Umum
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr class="signature-row">
                    <td colspan="6" style="border-left: 1px solid black; border-right: 1px solid black; border-top: none; border-bottom: 1px solid black; padding: 15px;">
                        <table style="width: 100%; border: none;">
                            <tr>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    <br><br><br><br>
                                    ( ${pejabatPengadaan ? pejabatPengadaan.nama : '........................'} )<br>
                                    NIP. ${pejabatPengadaan ? pejabatPengadaan.nip : '........................'}
                                </td>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    <br><br><br><br>
                                    ( ${kasubbag ? kasubbag.nama : '........................'} )<br>
                                    NIP. ${kasubbag ? kasubbag.nip : '........................'}
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr class="pengeluaran-title-row">
                    <td colspan="6" style="border: 1px solid black; padding: 8px; text-align: center; font-size: 11pt; font-weight: normal; background-color: white;">PENGELUARAN BARANG</td>
                </tr>
                <tr class="pengeluaran-content-row">
                    <td colspan="6" style="border-left: 1px solid black; border-right: 1px solid black; border-top: none; border-bottom: 1px solid black; padding: 15px;">
                        <table style="width: 100%; border: none;">
                            <tr>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    Petugas Gudang,<br><br><br><br><br><br>
                                    ( ${petugasGudang ? petugasGudang.nama : '........................'} )<br>
                                    NIP. ${petugasGudang ? petugasGudang.nip : '........................'}
                                </td>
                                <td style="border: none; width: 50%; text-align: center; vertical-align: top; padding: 10px;">
                                    Penerima Barang,<br><br><br><br><br><br>
                                    ( ${selectedUser ? selectedUser.nama : '........................'} )<br>
                                    NIP. ${selectedUser ? selectedUser.nip : '........................'}
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', signatureRows);
        }

        function exportToWord() {
            const content = document.getElementById('document-content').innerHTML;
            const bulanName = BULAN_NAMES[selectedBulan] || 'Bulan';
            const userName = selectedUser ? selectedUser.nama.replace(/\s+/g, '_') : 'User';
            const fileName = `Surat_Permintaan_ATK_${bulanName}_${selectedTahun}_${userName}.doc`;

            const wordDoc = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><title>Surat Permintaan Barang</title>
            <style>
                body{font-family:'Times New Roman',serif;font-size:12pt;margin:20px;line-height:1.4}
                table{border-collapse:collapse;width:100%}
                .main-table th{border:1px solid black;padding:6px;text-align:center;font-weight:normal}
                .main-table .data-row td{border:1px solid black;padding:6px;text-align:center}
                .main-table .name-column{text-align:left}
                .document-title{text-align:center;font-weight:bold;text-decoration:underline}
                .note-kasubbag{margin-top:10px;color:red}
            </style>
            </head>
            <body>${content}</body></html>`;

            const blob = new Blob([wordDoc], {type: 'application/msword'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            
            showToast("Dokumen Word berhasil didownload", "success");
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            if (el) {
                el.textContent = msg;
                el.style.display = msg ? 'block' : 'none';
            }
        }

        // UI HELPERS
        function showLoading(show, text = "Memproses...") {
            const overlay = document.getElementById("loadingOverlay");
            overlay.style.display = show ? "flex" : "none";
            document.getElementById("loadingText").textContent = text;
        }

        function showToast(message, type = "info") {
            const container = document.getElementById("toastContainer");
            const colors = {
                success: "linear-gradient(135deg, var(--primary-dark) 0%, #005a63 100%)",
                error: "linear-gradient(135deg, var(--accent-dark) 0%, #d08567 100%)",
                info: "linear-gradient(135deg, var(--primary-light) 0%, #70b3ab 100%)"
            };
            const icons = {
                success: "fas fa-check-circle",
                error: "fas fa-times-circle",
                info: "fas fa-info-circle"
            };

            const toastEl = document.createElement("div");
            toastEl.className = `toast align-items-center border-0 toast-${type}`;
            toastEl.setAttribute("role", "alert");
            toastEl.style.background = colors[type];
            toastEl.style.color = "white";
            toastEl.style.minWidth = "300px";
            toastEl.style.borderRadius = "12px";
            toastEl.style.boxShadow = "var(--shadow-md)";

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center" style="font-weight: 600;">
                        <i class="${icons[type]} me-2"></i>
                        <span>${message}</span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            container.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 4000
            });
            toast.show();

            toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
        }

        // INITIALIZATION
        document.addEventListener("DOMContentLoaded", async function() {
            await loadDataFromSheets();
            initializeDropdowns();
            initializeFormHandlers();

            loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
            tarikModal = new bootstrap.Modal(document.getElementById("tarikModal"));

            document.getElementById("loginForm").addEventListener("submit", handleLogin);
            document.getElementById("confirmTarikBtn").addEventListener("click", confirmTarik);

            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, "0");
            document.getElementById("filterBulan").value = currentMonth;

            // Set default active page
            document.getElementById("navForm").classList.add("active");
        });
    </script>
</body>
</html>
